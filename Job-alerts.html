from flask import Flask, jsonify, request, send_file, session, redirect, render_template_string
from flask_sqlalchemy import SQLAlchemy
from flask_cors import CORS
from io import BytesIO
from reportlab.pdfgen import canvas

app = Flask(__name__)
app.config['SECRET_KEY'] = 'your_secret_key_here'
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///database.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)
CORS(app, supports_credentials=True)

# Models
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    email = db.Column(db.String(120), unique=True)
    password = db.Column(db.String(120))

class Job(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    title = db.Column(db.String(150))
    location = db.Column(db.String(100))
    sector = db.Column(db.String(100))
    state = db.Column(db.String(100))
    link = db.Column(db.String(300))

@app.before_first_request
def create_tables():
    db.create_all()
    if Job.query.count() == 0:
        jobs = [
            Job(title="Railway Recruitment 2025", location="Delhi", sector="Railway", state="Delhi", link="https://www.indianrailways.gov.in/apply"),
            Job(title="SSC CGL 2025 Notification", location="Pan India", sector="SSC", state="All", link="https://ssc.nic.in/Apply"),
            Job(title="MP Bhulekh Job Vacancy", location="Madhya Pradesh", sector="State Govt", state="Madhya Pradesh", link="https://mpbhulekh.gov.in/mpbhulekh.do"),
            Job(title="SAARA MP Recruitment", location="Madhya Pradesh", sector="State Govt", state="Madhya Pradesh", link="https://saara.mp.gov.in/"),
            Job(title="MP eDistrict Jobs", location="Madhya Pradesh", sector="State Govt", state="Madhya Pradesh", link="https://mpedistrict.gov.in/MPL/index.aspx"),
            Job(title="RCMS MP Vacancy", location="Madhya Pradesh", sector="State Govt", state="Madhya Pradesh", link="https://rcms.mp.gov.in/Citizen/Default.aspx")
        ]
        db.session.bulk_save_objects(jobs)
        db.session.commit()

# API: get jobs with filters and pagination
@app.route('/api/jobs', methods=['GET'])
def get_jobs():
    page = int(request.args.get('page', 1))
    per_page = int(request.args.get('per_page', 5))
    state = request.args.get('state', '').lower()
    sector = request.args.get('sector', '').lower()
    search = request.args.get('search', '').lower()

    query = Job.query
    if state:
        query = query.filter(Job.state.ilike(f'%{state}%'))
    if sector:
        query = query.filter(Job.sector.ilike(f'%{sector}%'))
    if search:
        query = query.filter((Job.title.ilike(f'%{search}%')) | (Job.location.ilike(f'%{search}%')))

    paginated = query.paginate(page, per_page, error_out=False)
    jobs = [{
        'id': job.id,
        'title': job.title,
        'location': job.location,
        'sector': job.sector,
        'state': job.state,
        'link': job.link
    } for job in paginated.items]

    return jsonify({
        'jobs': jobs,
        'total': paginated.total,
        'pages': paginated.pages,
        'page': page
    })

# API: download job PDF
@app.route('/api/jobs/pdf/<int:job_id>', methods=['GET'])
def download_job_pdf(job_id):
    job = Job.query.get_or_404(job_id)
    buffer = BytesIO()
    p = canvas.Canvas(buffer)
    p.setFont("Helvetica-Bold", 16)
    p.drawString(100, 800, f"Job Title: {job.title}")
    p.setFont("Helvetica", 12)
    p.drawString(100, 770, f"Location: {job.location}")
    p.drawString(100, 750, f"Sector: {job.sector}")
    p.drawString(100, 730, f"State: {job.state}")
    p.drawString(100, 710, f"Apply Link: {job.link}")
    p.showPage()
    p.save()
    buffer.seek(0)
    return send_file(buffer, as_attachment=True, download_name=f"{job.title}.pdf", mimetype='application/pdf')

# User register/login/logout (simple, not secure for production)
@app.route('/api/auth/register', methods=['POST'])
def register():
    data = request.json
    if User.query.filter_by(email=data['email']).first():
        return jsonify({"error": "Email already registered"}), 400
    user = User(email=data['email'], password=data['password'])
    db.session.add(user)
    db.session.commit()
    return jsonify({"message": "Registered successfully"})

@app.route('/api/auth/login', methods=['POST'])
def login():
    data = request.json
    user = User.query.filter_by(email=data['email'], password=data['password']).first()
    if not user:
        return jsonify({"error": "Invalid credentials"}), 401
    session['user_id'] = user.id
    return jsonify({"message": "Logged in successfully"})

@app.route('/api/auth/logout', methods=['POST'])
def logout():
    session.pop('user_id', None)
    return jsonify({"message": "Logged out"})

# Serve frontend
@app.route('/')
def index():
    return render_template_string('''
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nearby Government Jobs - Free Job Alert</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #eef2f7;
    margin: 0;
    padding: 0;
    color: #333;
  }
  header {
    background: linear-gradient(90deg, #003366, #0066cc);
    color: white;
    padding: 1rem;
    text-align: center;
  }
  .container {
    max-width: 960px;
    margin: auto;
    padding: 1rem;
  }
  input, select, button {
    padding: 0.5rem;
    margin: 0.5rem 0;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  button {
    background: #0066cc;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover {
    background: #004a99;
  }
  .job-card {
    background: white;
    margin: 1rem 0;
    padding: 1rem;
    border-radius: 6px;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .job-info {
    max-width: 70%;
  }
  .job-info h3 {
    margin: 0;
  }
  .job-info p {
    margin: 0.3rem 0;
  }
  a.apply-btn {
    background: #008000;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    text-decoration: none;
  }
  a.apply-btn:hover {
    background: #005900;
  }
  .pagination {
    text-align: center;
    margin: 1rem 0;
  }
  .pagination button {
    margin: 0 0.25rem;
  }
  .filters {
    background: white;
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
  }
  .adsense {
    margin: 2rem 0;
    text-align: center;
  }
  footer {
    background: #003366;
    color: white;
    text-align: center;
    padding: 1rem;
    margin-top: 2rem;
  }
  /* Login/Signup */
  #authPanel {
    background: white;
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }
  #authPanel input {
    width: 100%;
  }
</style>
</head>
<body>

<header>
  <h1>Free Government Job Alerts</h1>
  <p>Search and apply to nearby government jobs</p>
</header>

<div class="container">
  <div id="authPanel">
    <h2 id="authTitle">Login</h2>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
    <p id="authMsg"></p>
  </div>

  <div class="filters" style="display:none;" id="filtersPanel">
    <input type="text" id="searchInput" placeholder="Search jobs by title or location" />
    <select id="stateFilter">
      <option value="">All States</option>
      <option value="Madhya Pradesh">Madhya Pradesh</option>
      <option value="Delhi">Delhi</option>
      <option value="All">All</option>
    </select>
    <select id="sectorFilter">
      <option value="">All Sectors</option>
      <option value="Railway">Railway</option>
      <option value="SSC">SSC</option>
      <option value="State Govt">State Govt</option>
    </select>
    <button onclick="loadJobs()">Filter</button>
  </div>

  <div id="jobList"></div>

  <div class="pagination" style="display:none;" id="paginationPanel">
    <button onclick="prevPage()">Prev</button>
    <span id="pageNum">1</span>
    <button onclick="nextPage()">Next</button>
  </div>

  <div class="adsense" style="display:none;" id="adsTop">
    <!-- Top Ad Space -->
    <p>[Ad placeholder top]</p>
  </div>

  <div class="adsense" style="display:none;" id="adsBottom">
    <!-- Bottom Ad Space -->
    <p>[Ad placeholder bottom]</p>
  </div>
</div>

<footer>
  &copy; 2025 FreeJobAlert Clone. All rights reserved.
</footer>

<script>
  let currentPage = 1;

  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authMsg = document.getElementById('authMsg');
  const authTitle = document.getElementById('authTitle');
  const filtersPanel = document.getElementById('filtersPanel');
  const paginationPanel = document.getElementById('paginationPanel');
  const adsTop = document.getElementById('adsTop');
  const adsBottom = document.getElementById('adsBottom');

  function showAuthUI(loggedIn) {
    if (loggedIn) {
      loginBtn.style.display = 'none';
      registerBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
      filtersPanel.style.display = 'block';
      paginationPanel.style.display = 'block';
      adsTop.style.display = 'block';
      adsBottom.style.display = 'block';
      authTitle.innerText = 'Welcome';
      authMsg.innerText = '';
      loadJobs();
    } else {
      loginBtn.style.display = 'inline-block';
      registerBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
      filtersPanel.style.display = 'none';
      paginationPanel.style.display = 'none';
      adsTop.style.display = 'none';
      adsBottom.style.display = 'none';
      authTitle.innerText = 'Login';
      authMsg.innerText = '';
      document.getElementById('jobList').innerHTML = '';
    }
  }

  // Check login status by trying to load jobs (will fail if not logged in)
  async function checkLogin() {
    try {
      const res = await fetch('/api/jobs?page=1&per_page=1', {credentials:'include'});
      if (res.ok) {
        showAuthUI(true);
      } else {
        showAuthUI(false);
      }
    } catch {
      showAuthUI(false);
    }
  }

  loginBtn.onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    if (!email || !password) {
      authMsg.innerText = 'Please enter email and password';
      return;
    }
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({email, password}),
      credentials: 'include'
    });
    const data = await res.json();
    if (res.ok) {
      authMsg.innerText = data.message;
      showAuthUI(true);
    } else {
      authMsg.innerText = data.error || 'Login failed';
    }
  };

  registerBtn.onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    if (!email || !password) {
      authMsg.innerText = 'Please enter email and password';
      return;
    }
    const res = await fetch('/api/auth/register', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({email, password}),
      credentials: 'include'
    });
    const data = await res.json();
    if (res.ok) {
      authMsg.innerText = data.message + ' You can now login.';
    } else {
      authMsg.innerText = data.error || 'Registration failed';
    }
  };

  logoutBtn.onclick = async () => {
    await fetch('/api/auth/logout', {
      method: 'POST',
      credentials: 'include'
    });
    showAuthUI(false);
  };

  async function loadJobs() {
    const search = document.getElementById('searchInput').value;
    const state = document.getElementById('stateFilter').value;
    const sector = document.getElementById('sectorFilter').value;

    const response = await fetch(`/api/jobs?page=${currentPage}&per_page=5&search=${search}&state=${state}&sector=${sector}`, {credentials: 'include'});
    if (!response.ok) {
      document.getElementById('jobList').innerHTML = '<p>Please login to see job listings.</p>';
      return;
    }
    const data = await response.json();
    const jobList = document.getElementById('jobList');
    jobList.innerHTML = '';

    if (data.jobs.length === 0) {
      jobList.innerHTML = '<p>No jobs found.</p>';
      return;
    }

    data.jobs.forEach(job => {
      const jobCard = document.createElement('div');
      jobCard.classList.add('job-card');

      jobCard.innerHTML = `
        <div class="job-info">
          <h3>${job.title}</h3>
          <p><strong>Location:</strong> ${job.location}</p>
          <p><strong>Sector:</strong> ${job.sector}</p>
          <p><strong>State:</strong> ${job.state}</p>
        </div>
        <div>
          <a class="apply-btn" href="${job.link}" target="_blank">Apply Now</a>
          <br /><br />
          <button onclick="downloadPDF(${job.id})">Download PDF</button>
        </div>
      `;

      jobList.appendChild(jobCard);
    });

    document.getElementById('pageNum').innerText = data.page;
  }

  function nextPage() {
    currentPage++;
    loadJobs();
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      loadJobs();
    }
  }

  async function downloadPDF(jobId) {
    const res = await fetch(`/api/jobs/pdf/${jobId}`, {credentials:'include'});
    if (res.ok) {
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'job-details.pdf';
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } else {
      alert('Failed to download PDF');
    }
  }

  checkLogin();

</script>

</body>
</html>
''')

